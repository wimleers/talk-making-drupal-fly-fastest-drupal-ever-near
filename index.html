<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Making Drupal fly â€” The fastest Drupal ever is near!</title>

		<meta name="author" content="Fabian Franz &amp; Wim Leers">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="src/reveal/css/reveal.css">
		<link rel="stylesheet" href="src/reveal/css/theme/black.css" id="theme">
		<link rel="stylesheet" href="custom.css">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="src/reveal/lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'src/reveal/css/print/pdf.css' : 'src/reveal/css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="src/reveal/lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Making Drupal fly</h1>
					<h3>The fastest Drupal ever is here!</h3>
					<p><em>ðŸŒ´ Barcelona edition ðŸŒ´</em></p>
					<br>
					<p>
						<ul>
							<li>Fabian Franz <small style="vertical-align: baseline">(<a href="https://tag1consulting.com/">Tag1 Consulting</a> â€” <a href="https://twitter.com/fabianfranz">@fabianfranz</a>)</small></li>
							<li>Wim Leers <small style="vertical-align: baseline">(<a href="https://acquia.com/">Acquia</a> â€” <a href="https://twitter.com/wimleers">@wimleers</a> â€” <a href="http://wimleers.com/">wimleers.com</a>)</small></li>
						</ul>
					</p>
				</section>

				<section>
					<section>
						<blockquote>
							<p class="curly" style="text-align: left;">I have installed Drupal. However, it's running very, very slowly. Hitting the front page or clicking on a link such as administer can result in delays of 15-30 seconds. Caching is enabled.
							<br>
							<br>
							There is almost nothing in my installation. Very few users, very little content.</p>
						</blockquote>
						<p class="fragment"><a href="https://www.drupal.org/node/63722">d.o/node/63722</a> â€” complaining about <strong>Drupal 4.7</strong>!</p>
					</section>
					<section>
						<h3>Drupal 5</h3>
						<blockquote><p class="curly">Why is my drupal site so slow?</p></blockquote>
						<p><a href="https://www.drupal.org/node/191060">https://www.drupal.org/node/191060</a></p>
						<small>November 2007</small>
					</section>
					<section>
						<h3>Drupal 6</h3>
						<blockquote><p class="curly">[â€¦] navigating between admin pages is slower than an arthritic snail.</p></blockquote>
						<p><a href="http://drupal.stackexchange.com/q/59895">http://drupal.stackexchange.com/q/59895</a></p>
						<small>February 2013</small>
					</section>
					<section>
						<h3>Drupal 7</h3>
						<blockquote><p class="curly">Drupal 7 is unnaceptably slow</p></blockquote>
						<p><a href="http://stackoverflow.com/q/7974842/80305">http://stackoverflow.com/q/7974842/80305</a></p>
						<small>November 2011</small>
					</section>
					<section>
						<p>Poor Drupalâ€¦</p>
						<img src="img/Im_A_Snail.jpg">
					</section>
					<section>
						<h3>Drupal 8</h3>
						<img class="fragment" src="img/drupalsnail.jpg">
						<blockquote class="fragment"><p class="curly">???</p></blockquote>
					</section>
					<section>
						<h2>Keep calm and cache!</h2>
					</section>
					<section>
						<h3>Page cache</h3>
						<h4>â€¦ in Drupal 3.0.0</h4>
						<pre><code class="php">function cache_get() {
  global $user, $REQUEST_URI, $REQUEST_METHOD;

  if (!$user->id && $REQUEST_METHOD == "GET") {
    if ($cache = db_fetch_object(db_query("SELECT * FROM cache WHERE url = '". check_input($REQUEST_URI) ."'"))) {
      cache_clear(variable_get("cache_clear", 30));
    }
    else {
      ob_start();
    }
  }

  return $cache->data ? $cache->data : 0;
}</code></pre>
						<p>â€¦ since <strong>June 30, 2001!</strong></p>
					</section>
					<section>
						<img src="img/drupal-5-performance-1.jpg" />
						<blockquote class="fragment"><p class="curly">[...] generating a page in Drupal 5 is 3% slower than in Drupal 4.7. [...] serving a cached page [...] Drupal 5 is 73% faster [...] and 268% faster when the aggressive database cache is used.</p></blockquote>
					</section>
					<section>
						<p>However Drupal 4.7 back then looked like this.</p>
						<img src="img/drupal-4.7-main-page.jpg" />
					</section>
					<section>
						<p>But overall ...</p>
					</section>
					<section>
						<p>We are starting to see a trend here.</p>
					</section>
				</section>

				<!-- Fabian -->
				<section>
					<section>
						<h2>Drupal 8</h2>
						<blockquote class="fragment"><p class="curly">Drupal 8 is the fastest Drupal ever.<p></blockquote>
						<p><a href="">Fabian Franz</a></p>
						<small>September 2015</small>
					</section>
					<section>
						<h2>The fastest Drupal ever?</h2>
					</section>
					<section>
						<h2>Are you serious?</h2>
					</section>
					<section>
						<h2>You are kidding right?</h2>
					</section>
					<section>
						<h2>But I thought Drupal 8 was slow!!!11111</h2>
					</section>
					<section>
						<h2>Everyone told me that!</h2>
					</section>
					<section>
						<h2>So it must be TRUE!</h2>
					</section>
					<section>
						<h2>And besides that, page cache was already in Drupal <del class="red">7</del> <span class="green">3</span>!</h2>
					</section>
					<section>
						<h2>Page Cache really does not count!</h2>
						<ul class="fragment">
							<li>( Except it does, as Wim will show you later. )</li>
						</ul>
					</section>
					<section>
						<h2>So let's take a look ...</h2>
					</section>
					<section>
						<h2>... at a very short demo ...</h2>
					</section>
					<section>
						<h2>... to show you ...</h2>
					</section>
					<section>
						<video src="SingleFlush versus BigPipe.mp4" controls>
					</section>
					<section>
						<h2>Confused?</h2>
					</section>
					<section>
						<h2>Let us take that more slowly.</h2>
					</section>
					<section>
						<video src="PlaceholderStrategies.mov" controls>
					</section>
					<section>
						<h2>What you just saw ...</h2>
					</section>
					<section>
						<h2>... is part of the mission ...</h2>
					</section>
					<section>
						<h2>... to make the whole web fast.</h2>
					</section>
					<section>
						<h3>Make the whole web fast</h3>
						<ul>
							<li>A challenge by Wim Leers.</li>
							<li class="fragment">http://calendar.perfplanet.com/2013/making-the-entire-web-fast/</li>
							<li class="fragment">Everyone profits from this!</li>
						</ul>
					</section>
					<section>
						<h3>Ambitious goal, so lets see what "fast" means:</h3>
						<ul class="fragment">
							<li>Great User Experience, pages load fast for 1 user</li>
							<li class="fragment">Great User Experience, pages load fast for [n] concurrent users</li>
							<li class="fragment">Time-to-First-Byte + Asset loading + Rendering + JS exec time == minimal</li>
						</ul>
					</section>
					<section>
						<h3>How do you achieve that?</h3>
						<ul class="fragment">
							<li class="fragment">SIMPLE!</li>
							<li class="fragment green">Use static HTML pages</li>
							<li class="fragment green">Use no CSS</li>
							<li class="fragment green">Use no Javascript</li>
							<li class="fragment green">Use no images</li>
							<li class="fragment green">Just text and links!</li>
						</ul>
					</section>
					<section>
						<h2>Seriously?</h2>
					</section>
					<section>
						<h2>No, of course not!</h2>
					</section>
					<section>
						<h2>There is some truth to that, though!</h2>
					</section>
					<section>
						<h3>Performance Optimization means:</h3>
						<p>Optimize to do:</p>
						<ul>
							<li class="fragment">As little work as possible!</li>
							<li class="fragment">As little resources as possible!</li>
						</ul>
					</section>
					<section>
						<h3>So for the "critical path" the process is:</h3>
						<h4>Can we:</h4>
						<ul>
							<li class="fragment">... avoid doing the work at all?</li>
							<li class="fragment">... avoid doing the work during the critical path?</li>
							<li class="fragment">... cache it permanently?</li>
							<li class="fragment">... cache it temporarily?</li>
							<li class="fragment">... defer executing it after the main content? (Big Pipe)</li>
						</ul>
					</section>
					<section>
						<h2>So, remember ACD:<br /><br />Avoid, Cache, Defer</h2>
					</section>
					<section>
						<h3>Caching has problems</h3>
						<h4>Content should:</h4>
						<ul>
							<li class="fragment">... be as current as possible.</li>
							<li class="fragment">... have a high cache hit ratio.</li>
							<li class="fragment">... have low cache invalidation complexity.</li>
						</ul>
						<h4 class="fragment red">Choose 2!</h4>
						<h4 class="fragment red">You can't have all three!</h4>
					</section>
					<section>
						<h3>Examples for low complexity cache invalidation:</h3>
						<h4>Time-Based Invalidation</h4>
						<ul>
							<li class="fragment">Cache pages unconditionally for a year, content is not really current, but cache hit ratio is great.</li>
							<li class="fragment">Cache pages never, content is always current, but cache-hit ratio is 0%.</li>
							<ul>
								<li class="red fragment">A <strong>lot</strong> of Drupal 7 sites operate that way right now :(</li>
							</ul>
							<li class="fragment">Cache pages for e.g. 6 hours, content is quite current and cache hit ratio is acceptable.</li>
						</ul>
					</section>
					<section>
						<h3>Examples for low complexity cache invalidation:</h3>
						<h4>Clear All Invalidation</h4>
						<ul>
							<li class="fragment">Whenever a page changes, clear the whole page cache.</li>
							<li class="red fragment">â‡’ Drupal 7's page cache operates like this by default.</li>
						</ul>
					</section>
					<section>
						<h3>Examples for high complexity cache invalidation (D7 contrib):</h3>
						<h4>Clear only what has changed</h4>
						<ul>
							<li class="fragment">e.g. <code>expire</code> / <code>varnish</code> module in D7.</li>
							<li class="fragment">Needs to purge / expire all URLs that contain content from anything and needs to track that.</li>
							<li class="red fragment">â‡’ High invalidation cost</li>
						</ul>
					</section>
					<section>
						<h3>Drupal 8 chose high-complexity</h3>
						<ul>
							<li class="green fragment">Content invalidated instantaneously</li>
							<li class="green fragment">Cached permanently</li>
							<li class="fragment">Solution: Cache Tags (explained later)</li>
						</ul>
					</section>
					<section>
						<h3>Caching has <strong class="red">more</strong> problems</h3>
						<h4>Content should:</h4>
						<ul>
							<li class="fragment">... be varied by a user / group / special permission / phase of the moon (granularity).</li>
							<li class="fragment">... have a high cache hit ratio.</li>
							<li class="fragment">... have low complexity (logic needed to ensure caches are granularly varied).</li>
						</ul>
						<h4 class="fragment red">Choose 2!</h4>
						<h4 class="fragment red">You can't have all three!</h4>
						<h4 class="fragment">( What again? )</h4>
					</section>
					<section>
						<h3>Drupal 8 chose high-complexity</h3>
						<ul>
							<li class="green fragment">Everything declares what it varies by.</li>
							<li class="green fragment">This allows caching authenticated user content securely.</li>
							<li class="fragment">Solution: Cache Contexts (explained later) + Placeholders</li>
						</ul>
					</section>
					<section>
						<h2>Wait a moment!</h2>
					</section>
					<section>
						<h2>What about KISS?</h2>
						<h3>(Keep It Simple, Stupid!)</h3>
					</section>
					<section>
						<h2>Counter Question:</h2>
					</section>
					<section>
						<h2>Who of you uses a database?</h2>
					</section>
					<section>
						<h2>Databases are actually "beasts of complexity"</h2>
						<h3 class="fragment">... but you don't see any of that!</h3>
						<h3 class="fragment">... you just give hints and the database does its magic.</h3>
					</section>
					<section>
						<h3>Drupal 8 makes it as simple as possible for you!</h3>
						<ul>
							<li class="fragment">Huge opportunity!</li>
							<li class="fragment">Drupal 8 does all the caching logic internally.</li>
							<li class="fragment">If you give Drupal information, then it can be smarter about its decisions.</li>
						</ul>
					</section>
					<section>
						<h2>Drupal 8 formalizes those things in a "language" to make <strong>your</strong> site fast.</h2>
					</section>
					<section>
						<h2>Drupal 7 can use the same "language" â€” once it is finalized in Drupal 8.</h2>
						<ul>
						  <li>render_cache 7.x-2.x module
                                                  <li>service_container â€” using the same code base as Drupal 8</li>
                                                  <li class="fragment">[ developed in parallel, but 7.x frozen atm. ]</li>
						</ul>
					</section>
					<section>
						<h2>But how do I give this information?</h2>
					</section>
					<section>
						<h2>Wim will show you now!</h2>
					</section>
				</section>

				<!-- Wim -->
				<section>
					<section>
						<h2>The thought process</h2>
						<p>The theory of how we make Drupal fast.</p>
					</section>
					<section>
						<h3>Dependencies, dependencies, dependencies!</h3>
						<ul class="fragment">
							<li>Drupal 7 didn't track <em>any</em> dependencies
							<li class="fragment">e.g. <code>drupal_add_css()</code>, <code>drupal_add_js()</code> â€¦
							</li>
							<li class="fragment">â‡’ Global state: impossible to cache</li>
							<li class="fragment">â‡’ <code>#attached</code> asset libraries solve that</li>
						</ul>
					</section>
					<section>
						<h3>Dependencies, dependencies, dependencies!</h3>
						<ul>
							<li>Drupal 7 didn't track <em>any</em> dependencies
							<li class="fragment">e.g. <a href="https://api.drupal.org/api/drupal/includes%21common.inc/function/url/7"><code>url()</code></a>'s output depended on:
								<ul style="font-size: 70%">
									<li class="fragment"><code>&lt;front&gt;</code> configuration
									<li class="fragment">HTTPS configuration
									<li class="fragment">clean URL configuration
									<li class="fragment">current site in multisite
									<li class="fragment">current host name
									<li class="fragment">path processing
										<ul>
											<li class="fragment">negotiated interface language
											<li class="fragment">negotiated URL language
											<li class="fragment">â€¦</li>
										</ul>
									</li>
								</ul>
							</li>
							<li class="fragment red">â‡’ impossible to <del>cache</del> <ins>invalidate</ins></li>
							<li class="fragment"><em> â€¦ yet many of us did it anyway!</em></li>
						</ul>
					</section>
					<section>
						<h3>Correct invalidation in Drupal 8</h3>
						<ul>
							<li>Cache tags <small class="fragment">(data dependencies)</small>
							<li>Cache contexts <small class="fragment">(context dependencies)</small>
							<li>Cache max-age <small class="fragment">(time dependencies)</small>
						</ul>
						<div class="fragment">
							<p>+</p>
							<p>Cacheability bubbled during rendering!</p>
						</div>
					</section>
					<section>
						<h3>In practice</h3>
						<p>Try to make this thought process a habit:</p>
					</section>
					<section>
						<h3>1.</h3>
						<blockquote>I'm rendering something. That means I must think of cacheability!</blockquote>
					</section>
					<section>
						<h3>2.</h3>
						<blockquote>Is this something that's expensive to render, and therefore is worth caching?</blockquote>
						<p>â†ªï¸Ž If "yes": <strong>cache keys</strong>.</p>
						<pre class="fragment" style="margin-top: 3em; width: 70%"><code class="php">$build['#cache']['keys'] = ['node', 5, 'teaser'];</code></pre>
					</section>
					<section>
						<h3>3.</h3>
						<blockquote>Does the representation of the thing I'm rendering vary per combination of permissions, per URL, per interface language, per â€¦ something?</blockquote>
						<p>â†ªï¸Ž If "yes": <strong>cache contexts</strong>.</p>
						<pre class="fragment" style="margin-top: 3em; width: 70%"><code class="php">$build['#cache']['contexts'][] = 'user.permissions';
$build['#cache']['contexts'][] = 'url';
</code></pre>
						<p class="fragment"><small>~ HTTP's <code>Vary</code> header</small></p>
					</section>
					<section>
						<h3>4.</h3>
						<blockquote>What causes the representation of the thing I'm rendering become outdated?</blockquote>
						<p>â†ªï¸Ž If "yes": <strong>cache tags</strong>.</p>
						<pre class="fragment" style="margin-top: 3em; width: 70%"><code class="php">$build['#cache']['tags'][] = 'node:5';
$build['#cache']['tags'][] = 'user:3';
$build['#cache']['tags'][] = 'taxonomy_term:23';
</code></pre>
					</section>
					<section>
						<h3>5.</h3>
						<blockquote>When does the representation of the thing I'm rendering become outdated?</blockquote>
						<p>â†ªï¸Ž If "yes": <strong>cache max-age</strong>.</p>
						<pre class="fragment" style="margin-top: 3em; width: 70%"><code class="php">$build['#cache']['max-age'] = Cache::PERMANENT;</code></pre>
						<p class="fragment"><small>~ HTTP's <code>Cache-Control: max-age</code> header</small></p>
					</section>
					<section>
						<p>All relevant objects provide cacheability metadata!</p>
						<pre><code class="php">interface CacheableDependencyInterface {
  public function getCacheContexts();
  public function getCacheTags();
  public function getCacheMaxAge();
}</code></pre>
						<div class="fragment">
							<p>Implemented by:</p>
							<ul>
								<li>configuration + entities (content &amp; config)</li>
								<li>access results</li>
								<li>block, context, condition plugins</li>
								<li>â€¦</li>
							</ul>
						</div>
					</section>
					<section>
						<p>To make it easier:</p>
						<p><small><code class="php">Renderer::addCacheableDependency($build, $dependency)</code></small></p>
						<pre class="fragment"><code class="php">$site_config = $this->config->get('system.site');

$build = [
  '#markup' => t('Welcome to @site, @user!', $site_config->get('name')),
];
$this->renderer->addCacheableDependency($build, $site_config)</code></pre>
					</section>
					<section>
						<h3>If Drupal pages were shipsâ€¦</h3>
						<p>(Drupal rendering a page ~ building a ship)</p>
					</section>
					<section>
						<h3>â€¦ then this could be Drupal 8â€¦</h3>
						<figure>
							<img src="img/lego-ship-drupal8.jpg">
							<figcaption>Assembled from components. Clear dependencies.</figcaption>
						</figure>
					</section>
					<section>
						<h3>â€¦ and this would be Drupal 7</h3>
						<figure>
							<img src="img/lego-ship-drupal7.jpg">
							<figcaption>Assembled from seemingly random pieces. <em>But it is a boat!</em></figcaption>
						</figure>
					</section>
				</section>

				<section>
                                        <section>
                                                <p>So the remaining problem we faced was ...</p>
                                        </section>
                                        <section>
                                                <p>... that even with all those dependencies ...</p>
                                        </section>
                                        <section>
                                                <p>... the cacheability was not good.</p>
                                        </section>
                                        <section>
                                                <p>... and things were slower than they could be. <span class="red">:-(</span></p>
                                        </section>
                                        <section>
                                                <p>But why?</p>
                                        </section>
                                        <section>
                                                <h2>Pages are: Static + Dynamic<h2>
                                                <img src="img/DynamicOverview.png" height="500" />
                                        </section>
                                        <section>
                                                <h2>Pages have dynamic parts<h2>
                                                <img src="img/DynamicSlow.png" height="500" />
                                        </section>
                                        <section>
                                                <h2>Pages are too dynamic<h2>
                                                <img src="img/DynamicTooMany.png" height="500" />
                                        </section>
                                        <section>
                                                <p>So let's make the pages less dynamic</p>
                                                <h2>Problem solved!</h2>
                                        </section>
                                        <section>
                                                <h2>UHM ...</h2>
                                        </section>
                                        <section>
                                                <h2>NOPE!</h2>
                                        </section>
<!--
                                        <section>
                                                <h2>WAIT!</h2>
                                                <p class="fragment">But the Web 3.0 is all about personalized experiences!</p>
                                                <p class="fragment">I need dynamic pages!</p>
                                                <p class="fragment">Or I go back to plain HTML!</p>
                                                <p class="fragment">And don't forget about shopping carts!</p>
                                        </section>
-->
                                        <section>
                                                <p>Fortunately!</p>
                                        </section>
                                        <section>
                                                <p>Drupal 8 has a solution for that!</p>
                                                <p class="fragment">- and it is already in Core!</p>
                                        </section>
                                        <section>
                                                <h2>Placeholders and Auto-Placeholdering!</h2>
                                        </section>
                                        <section>
                                                <h2>No more of this!</h2>
                                                <img src="img/DynamicNoMore.png" height="500" />
                                        </section>
                                        <section>
                                                <h2>Drupal 8 knows your page</h2>
                                                <img src="img/CacheContexts.png" height="500" />
                                        </section>
                                        <section>
                                                <h2>It can automatically placeholder</h2>
                                                <img src="img/Placeholdering.png" height="500" />
                                        </section>
					<section>
                                                <h2>And it looks like this to Drupal</h2>
                                                <img src="img/PlaceholdersComplex.png" height="500" />
                                        </section>
					<section>
                                                <h2>Stored in #attached</h2>
                                                <img src="img/PlaceholdersAttached.png" height="500" />
                                        </section>
				</section>

				<!-- Wim -->
				<section>
					<section>
						<h2><code>#lazy_builder</code></h2>
					</section>
					<section>
						<pre><code class="php">$build['complex_thing'] = [
  '#lazy_builder' => [$callback, $args]
];</code></pre>
						<aside class="notes">
							This is the general structure: a render array with only a lazy builder callback; there can only be one such callback, and it may optionally receive arguments.
						</aside>
					</section>
					<section>
						<pre><code class="php">$output['comment_form'] = [
  '#lazy_builder' => ['comment.lazy_builders:renderForm', [
    $entity->getEntityTypeId(),
    $entity->id(),
    $field_name,
    $this->getFieldSetting('comment_type'),
  ]],
];
</code></pre>
						<aside class="notes">
							Here's a concrete example from Drupal 8: the comment form. As you can see, it can also be a method on a service (and that service can have other services injected). We pass it the commented entity type, commented entity ID, the comment field name and the commment type.
						</aside>
					</section>
					<section>
						<pre><code class="php">throw new \DomainException("A #lazy_builder callback's context may
                           only contain scalar values or NULL.");</code></pre>
						<aside class="notes">
							Lazy builders are <em>very</em> strict in what they accept.
						</aside>
					</section>
					<section>
						<pre><code class="php">throw new \DomainException(sprintf('When a #lazy_builder callback
                           is specified, no children can exist; all
                           children must be generated by the
                           #lazy_builder callback. You specified
                           the following children: %s.',
                           implode(', ', $children)));</code></pre>
						<aside class="notes">
							Lazy builders are <em>very</em> strict in what they accept. And they guide you in the right direction, which is â€¦
						</aside>
					</section>
					<section>
						<p>A <code>#lazy_builder</code>:</p>
						<ol>
							<li>builds a render array and returns it</li>
							<li>output must depend solely on the input (arguments)</li>
						</ol>
						<p>â‡’ able to render in isolation!</p>
					</section>
				</section>

				<!-- Wim -->
				<section>
					<section>
						<h2>Auto-placeholdering</h2>
						<pre><code>  renderer.config:
    auto_placeholder_conditions:
      max-age: 0
      contexts: ['session', 'user']
      tags: []
</code></pre>
						<p>Configurable!</p>
					</section>
					<section>
						<pre><code class="php">$output['comment_form'] = [
  '#lazy_builder' => ['comment.lazy_builders:renderForm', â€¦]
];
</code></pre>
					<p>â¬‡ï¸Ž</p>
					<pre><code class="php">$output['comment_form'] = [
  '#lazy_builder' => ['comment.lazy_builders:renderForm', â€¦]
  '#cache' => [
    'contexts' => ['user'],
  ],
];
</code></pre>
					</section>
					<section>
						<h3>Auto-placeholdering conditions met</h3>
					<pre><code class="php">$output['comment_form'] = [
  '#lazy_builder' => ['comment.lazy_builders:renderForm', â€¦]
  '#cache' => [
    'contexts' => ['user'],
  ],
];
</code></pre>
					<p>â¬‡ï¸Ž</p>
					<pre><code class="php">$output['comment_form'] = [
  '#lazy_builder' => ['comment.lazy_builders:renderForm', â€¦]
  '#cache' => [
    'contexts' => ['user'],
  ],
  '#create_placeholder' => TRUE,
];
</code></pre>
					</section>
					<section>
						<h3>Placeholder created</h3>
					<pre><code class="php">$output['comment_form'] = [
  '#lazy_builder' => ['comment.lazy_builders:renderForm', â€¦]
  '#cache' => ['contexts' => ['user']],
  '#create_placeholder' => TRUE,
];
</code></pre>
					<p>â¬‡ï¸Ž</p>
					<pre><code class="php">$output['comment_form'] = [
  '#markup' => '<drupal-render-placeholder callback="comment.lazy_builders:renderForm" arguments="â€¦"" token="876ade565d79d"></drupal-render-placeholder>',
  '#attached' => [
    'placeholders' => [
      '<drupal-render-placeholder callback="comment.lazy_builders:renderForm" arguments="â€¦"" token="876ade565d79d"></drupal-render-placeholder>' => [
        '#lazy_builder' => ['comment.lazy_builders:renderForm', â€¦]
        '#cache' => ['contexts' => ['user']],
      ],
    ],
  ],
];
</code></pre>
					</section>
				</section>

				<!-- Fabian -->
				<section>
					<section>
						<h2>Placeholder render strategies</h2>
					</section>
					<section>
						<pre><code>placeholder_strategy:
  class: Drupal\Core\Render\Placeholder\ChainedPlaceholderStrategy
  tags:
    - { name: service_collector, tag: placeholder_strategy, call: addPlaceholderStrategy }
placeholder_strategy.single_flush:
  class: Drupal\Core\Render\Placeholder\SingleFlushStrategy
  tags:
    - { name: placeholder_strategy, priority: -1000 }
</code></pre>
					</section>
					<section>
						<pre><code class="php">class SingleFlushStrategy implements PlaceholderStrategyInterface {

  public function processPlaceholders(array $placeholders) {
    // Return all placeholders as is; they should be rendered directly.
    return $placeholders;
  }

}
</code></pre>
					</section>
					<section>
						<pre><code class="php">class BigPipeStrategy implements PlaceholderStrategyInterface {
  public function processPlaceholders(array $placeholders) {
    foreach ($placeholders as $placeholder => $placeholder_elements) {
      $return[$placeholder] = [
        '#markup' => '<div data-big-pipe-selector="' . Html::getId($placeholder) . '"></div>',
        '#cache' => [
          'max-age' => 0,
        ],
        '#attached' => [
          'library' => ['big_pipe/big_pipe'],
        ],
      ];
    }
    return $return;
  }
}
</code></pre>
					</section>
				</section


				<!-- Fabian + Wim -->
				<section>
					<!-- Wim -->
					<section>
						<h2>Pitfalls + Scenarios</h2>
					</section>
					<section>
						<h3>Depending on configuration?</h3>
						<p>Don't forget to add its cache tags!</p>
						<p><pre style="width: 70%"><code class="php">Renderer::addCacheableDependency($build, $config)</code></pre></p>
					</section>
					<section>
						<h3>Depending on an entity?</h3>
						<p>Don't forget to add its cache tags!</p>
						<p><pre style="width: 70%"><code class="php">Renderer::addCacheableDependency($build, $entity)</code></pre></p>
					</section>
					<section>
						<h3>Depending on a field of an entity?</h3>
						<p>Don't forget to add the entity's cache tags!</p>
						<p><pre style="width: 70%"><code class="php">Renderer::addCacheableDependency($build, $entity)</code></pre></p>
					</section>
					<section>
						<h3>Uncacheable data?</h3>
						<p>Don't forget to set max-age to zero!</p>
						<p><pre style="width: 50%"><code class="php">$build['#cache']['max-age'] = 0;</code></pre></p>
					</section>
					<section>
						<h3>Manually rendering a link?</h3>
						<p>Either:</p>
						<ul>
							<li>Use Twig:
								<pre><code class="twig" style="width: 110%">{{ link(something.title, something.url) }}</code></pre>
							</li>
							<li>Use <code>#type => link</code>:
								<pre><code class="php" style="width: 110%">$build['link'] = [
  '#type' => 'link',
  '#title' => 'Drupal',
  '#url' => Url::fromUri('https://drupal.org'),
];</code></pre>
							</li>
						</ul>
					</section>
					<!-- Fabian -->
					<section>
						<h3>Scenario: vary by cookie</h3>
						<pre><code>$args = ['%username' => $_COOKIE['username']];
$build['#markup'] = $this->t('Hi, %username', $args);

$build['#cache']['contexts'][] = 'cookies:username';</code></pre>
					</section>
					<section>
						<h3>Scenario: <em>always</em> vary by a 'device' cookie</h3>
						<p>In <code>sites/yoursite.com/services.yml</code>:
						<pre><code>parameters:
  renderer.config:
    required_cache_contexts:
      # The two default required cache contexts.
      - 'languages:language_interface'
      - 'theme'

      # The one we added!
      - 'cookies:device'
</code></pre>
					</section>

					<!-- more to follow -->
				</section>

				<!-- Fabian + Wim -->
				<section>
					<h3>Hope you liked it!</h3>
					<h2>Questions?</h2>
					<p style="font-size: 95%"><a href="http://wimleers.com/talk/making-drupal-fly-fastest-drupal-ever-near">wimleers.com/talk/making-drupal-fly-fastest-drupal-ever-near</a></p>
					<hr>
					<h4>Docs</h4>
					<p><a href="https://www.drupal.org/developing/api/8/cache/contexts">d.o/developing/api/8/cache/contexts</a></p>
					<p><a href="https://www.drupal.org/developing/api/8/render/arrays/cacheability">d.o/developing/api/8/render/arrays/cacheability</a></p>
					<br>
					<h4>BigPipe issue</h4>
					<p><a href="https://www.drupal.org/node/2469431">d.o/node/2469431</a></p>
				</section>

			</div>

		</div>

		<script src="src/reveal/lib/js/head.min.js"></script>
		<script src="src/reveal/js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'src/reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'src/reveal/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'src/reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'src/reveal/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'src/reveal/plugin/zoom-js/zoom.js', async: true },
					{ src: 'src/reveal/plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
